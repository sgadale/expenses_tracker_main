{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <!-- ================= DASHBOARD HEADER ================= -->
    <h2 class="mb-4">Dashboard</h2>

    <!-- ================= SUMMARY CARDS ================= -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>Total Expense</h6>
                    <h4>â‚¹{{ total_expense }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>Budget</h6>
                    <h4>â‚¹{{ budget_amount }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6>Remaining</h6>
                    <h4>â‚¹{{ remaining_amount }}</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ACTION ROW ================= -->
    <div class="d-flex align-items-center gap-2 mb-4">

        <!-- Add Expense -->
        <button
            class="btn btn-success"
            data-bs-toggle="modal"
            data-bs-target="#addExpenseModal">
            + Add Expense
        </button>

        <!-- Set Budget -->
        <button
            class="btn btn-secondary"
            data-bs-toggle="modal"
            data-bs-target="#setBudgetModal">
            Set Budget
        </button>

        <!-- ================= FILTER ================= -->
        <form method="get" class="d-flex align-items-center gap-2 ms-2">

            <!-- Selected month display -->
            <input
                type="text"
                id="selectedMonthDisplay"
                class="form-control"
                style="width:140px"
                readonly
                value="{{ selected_month|default:'' }}">

            <!-- Hidden month input -->
            <input
                type="month"
                name="month"
                id="monthInput"
                class="d-none"
                value="{{ selected_month|default:'' }}">

            <!-- Calendar icon -->
            <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="document.getElementById('monthInput').showPicker()">
                ðŸ“…
            </button>

            <!-- Apply Filter -->
            <button
                class="btn btn-primary"
                type="submit"
                id="filterBtn"
                {% if not selected_month %}disabled{% endif %}>
                Filter
            </button>

            <!-- Clear Filter -->
            {% if selected_month %}
            <a href="{% url 'dashboard' %}" class="btn btn-outline-danger">
                Clear
            </a>
            {% endif %}
        </form>
    </div>

    <!-- ================= TABS ================= -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#expensesTab">
                Expenses
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#categoryTab">
                Category-wise Total
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- ================= EXPENSES TAB ================= -->
        <div class="tab-pane fade show active" id="expensesTab">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr>
                        <td>{{ expense.title }}</td>
                        <td>{{ expense.category }}</td>
                        <td>â‚¹{{ expense.amount }}</td>
                        <td>{{ expense.date }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No expenses found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ================= CATEGORY TAB ================= -->
        <div class="tab-pane fade" id="categoryTab">
            <table class="table table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Category</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in category_totals %}
                    <tr>
                        <td>{{ row.category }}</td>
                        <td>â‚¹{{ row.total }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" class="text-center">No data</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- ================= ADD EXPENSE MODAL ================= -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'add_expense' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {{ expense_form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= SET BUDGET MODAL ================= -->
<div class="modal fade" id="setBudgetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'set_budget' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Set Monthly Budget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {{ budget_form.as_p }}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= FILTER JS ================= -->
<script>
    const monthInput = document.getElementById("monthInput");
    const displayInput = document.getElementById("selectedMonthDisplay");
    const filterBtn = document.getElementById("filterBtn");

    if (monthInput) {
        monthInput.addEventListener("change", function () {
            displayInput.value = this.value;
            filterBtn.disabled = !this.value;
        });
    }
</script>

{% endblock %}
