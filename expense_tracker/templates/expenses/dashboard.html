{% extends 'base.html' %}
{% block content %}

<h3 class="mb-4">Dashboard</h3>

<!-- ================= Summary Cards ================= -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm p-3">
            <h6>Total Expense</h6>
            <h4 class="mb-0">â‚¹{{ total_expense }}</h4>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm p-3">
            <h6>Budget</h6>
            <h4 class="mb-0">
                {% if budget %}â‚¹{{ budget.amount }}{% else %}Not Set{% endif %}
            </h4>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm p-3">
            <h6>Remaining</h6>
            <h4 class="mb-0">â‚¹{{ remaining }}</h4>
        </div>
    </div>
</div>

<!-- ================= Actions + Filter Row ================= -->
<div class="row align-items-center mb-4">

    <div class="col-auto">
        <button type="button" class="btn btn-success"
                data-bs-toggle="modal" data-bs-target="#addExpenseModal">
            + Add Expense
        </button>
    </div>

    <div class="col-auto">
        <button type="button" class="btn btn-secondary"
                data-bs-toggle="modal" data-bs-target="#budgetModal">
            Set Budget
        </button>
    </div>

    <!-- Filter -->
    <div class="col-auto ms-auto">
        <form method="get" id="monthFilterForm"
              class="d-flex align-items-center gap-2">

            <!-- Selected Month Display -->
            <span id="selectedMonthLabel"
                  class="badge bg-light text-dark border px-3 py-2">
                {% if selected_month %}
                    {% with selected_month|slice:":4" as year %}
                    {% with selected_month|slice:"5:7" as month %}
                        {% if month == "01" %}Jan{% elif month == "02" %}Feb{% elif month == "03" %}Mar
                        {% elif month == "04" %}Apr{% elif month == "05" %}May{% elif month == "06" %}Jun
                        {% elif month == "07" %}Jul{% elif month == "08" %}Aug{% elif month == "09" %}Sep
                        {% elif month == "10" %}Oct{% elif month == "11" %}Nov{% elif month == "12" %}Dec
                        {% endif %}
                        {{ year }}
                    {% endwith %}
                    {% endwith %}
                {% else %}
                    No filter
                {% endif %}
            </span>

            <!-- Month Picker -->
            <label class="month-picker-wrapper mb-0">
                <input type="month"
                       name="month"
                       id="monthPicker"
                       value="{{ selected_month }}"
                       class="month-picker-hidden">
                <span class="calendar-icon">ðŸ“…</span>
            </label>

            <!-- Apply Filter -->
            <button class="btn btn-primary" type="submit">
                Filter
            </button>
        </form>
    </div>

</div>

<!-- ================= Tabs ================= -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#expenses"
                type="button">
            Expenses
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#category"
                type="button">
            Category-wise Total
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- Expenses Tab -->
    <div class="tab-pane fade show active" id="expenses">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th width="140">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.title }}</td>
                    <td>{{ expense.category }}</td>
                    <td>â‚¹{{ expense.amount }}</td>
                    <td>{{ expense.date }}</td>
                    <td>
                        <a href="{% url 'edit_expense' expense.id %}"
                           class="btn btn-sm btn-warning">Edit</a>
                        <a href="{% url 'delete_expense' expense.id %}"
                           class="btn btn-sm btn-danger">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center">
                        No expenses found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Category Tab -->
    <div class="tab-pane fade" id="category">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Category</th>
                    <th>Total Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for item in category_totals %}
                <tr>
                    <td>{{ item.category__name }}</td>
                    <td>â‚¹{{ item.total }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2" class="text-center">
                        No data available
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<!-- ================= JS (UPDATE LABEL ONLY) ================= -->
<script>
const monthPicker = document.getElementById('monthPicker');
const monthLabel = document.getElementById('selectedMonthLabel');

monthPicker.addEventListener('change', function () {
    if (!this.value) return;

    const [year, month] = this.value.split('-');
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    monthLabel.textContent = `${monthNames[parseInt(month) - 1]} ${year}`;
});
</script>

<!-- ================= CSS ================= -->
<style>
.month-picker-wrapper {
    position: relative;
    cursor: pointer;
}

.month-picker-hidden {
    position: absolute;
    opacity: 0;
    width: 32px;
    height: 32px;
    cursor: pointer;
}

.calendar-icon {
    font-size: 18px;
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    background: #fff;
}
</style>

{% endblock %}
